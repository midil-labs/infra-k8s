apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: onekg-platform
  namespace: argocd
  labels:
    app.kubernetes.io/name: onekg-platform-project
    app.kubernetes.io/part-of: onekg-platform
    platform.onekg.io/component: infrastructure
spec:
  description: "OneKG Microservices Platform - Centralized project for all OneKG services and infrastructure"
  
  # Source repositories allowed for this project
  sourceRepos:
    - "https://github.com/midil-labs/infra-k8s.git"
    - "https://github.com/midil-labs/onekg-backend-*"
    - "https://github.com/midil-labs/onekg-frontend-*"
  
  # Destination clusters and namespaces
  destinations:
    # Infrastructure components
    - namespace: "onekg-backend"
      server: "https://kubernetes.default.svc"
    - namespace: "onekg-sealed-secrets"
      server: "https://kubernetes.default.svc"
    - namespace: "onekg-monitoring"
      server: "https://kubernetes.default.svc"
    - namespace: "onekg-logging"
      server: "https://kubernetes.default.svc"
    - namespace: "onekg-ingress"
      server: "https://kubernetes.default.svc"
    - namespace: "argocd"
      server: "https://kubernetes.default.svc"
    - namespace: "default"
      server: "https://kubernetes.default.svc"
  
  # Cluster resource allowlist
  clusterResourceWhitelist:
    - group: ""
      kind: "Namespace"
    - group: "rbac.authorization.k8s.io"
      kind: "ClusterRole"
    - group: "rbac.authorization.k8s.io"
      kind: "ClusterRoleBinding"
    - group: "storage.k8s.io"
      kind: "StorageClass"
    - group: "networking.k8s.io"
      kind: "NetworkPolicy"
  
  # Namespace resource allowlist
  namespaceResourceWhitelist:
    - group: ""
      kind: "ConfigMap"
    - group: ""
      kind: "Secret"
    - group: ""
      kind: "Service"
    - group: ""
      kind: "ServiceAccount"
    - group: ""
      kind: "PersistentVolumeClaim"
    - group: "apps"
      kind: "Deployment"
    - group: "apps"
      kind: "StatefulSet"
    - group: "apps"
      kind: "DaemonSet"
    - group: "autoscaling"
      kind: "HorizontalPodAutoscaler"
    - group: "policy"
      kind: "PodDisruptionBudget"
    - group: "rbac.authorization.k8s.io"
      kind: "Role"
    - group: "rbac.authorization.k8s.io"
      kind: "RoleBinding"
    - group: "networking.k8s.io"
      kind: "Ingress"
    - group: "networking.k8s.io"
      kind: "NetworkPolicy"
    - group: "traefik.containo.us"
      kind: "IngressRoute"
    - group: "traefik.containo.us"
      kind: "Middleware"
    - group: "bitnami.com"
      kind: "SealedSecret"
    - group: "argoproj.io"
      kind: "Application"
  
  # Roles for different team members
  roles:
    # Platform Admin - Full access to all resources
    - name: platform-admin
      description: "Platform administrators with full access"
      policies:
        - p, proj:onekg-platform:platform-admin, applications, *, onekg-platform/*, allow
        - p, proj:onekg-platform:platform-admin, repositories, *, *, allow
        - p, proj:onekg-platform:platform-admin, clusters, *, *, allow
        - p, proj:onekg-platform:platform-admin, exec, *, onekg-platform/*, allow
        - p, proj:onekg-platform:platform-admin, logs, *, onekg-platform/*, allow
      groups:
        - "onekg-platform-admins"
    
    # DevOps Engineer - Can manage applications and view logs
    - name: devops-engineer
      description: "DevOps engineers with application management access"
      policies:
        - p, proj:onekg-platform:devops-engineer, applications, *, onekg-platform/*, allow
        - p, proj:onekg-platform:devops-engineer, repositories, get, *, allow
        - p, proj:onekg-platform:devops-engineer, clusters, get, *, allow
        - p, proj:onekg-platform:devops-engineer, exec, *, onekg-platform/*, allow
        - p, proj:onekg-platform:devops-engineer, logs, *, onekg-platform/*, allow
      groups:
        - "onekg-devops"
    
    # Developer - Can view applications and logs, limited management
    - name: developer
      description: "Developers with read access and limited management"
      policies:
        - p, proj:onekg-platform:developer, applications, get, onekg-platform/*, allow
        - p, proj:onekg-platform:developer, applications, sync, onekg-platform/*, allow
        - p, proj:onekg-platform:developer, repositories, get, *, allow
        - p, proj:onekg-platform:developer, clusters, get, *, allow
        - p, proj:onekg-platform:developer, logs, *, onekg-platform/*, allow
      groups:
        - "onekg-developers"
    
    # Read-only - View access only
    - name: read-only
      description: "Read-only access for monitoring and auditing"
      policies:
        - p, proj:onekg-platform:read-only, applications, get, onekg-platform/*, allow
        - p, proj:onekg-platform:read-only, repositories, get, *, allow
        - p, proj:onekg-platform:read-only, clusters, get, *, allow
        - p, proj:onekg-platform:read-only, logs, *, onekg-platform/*, allow
      groups:
        - "onekg-readonly"
  
  # Sync windows for controlled deployments
  syncWindows:
    # Production sync window - only during business hours
    - name: production-sync
      schedule: "0 9-17 * * 1-5"  # 9 AM to 5 PM, Monday to Friday
      duration: "8h"
      applications:
        - "onekg-platform"
        - "onekg-namespaces"
        - "onekg-sealed-secrets"
      timeZone: "UTC"
      manualSync: true
      automaticSync: false
    
    # Development sync window - anytime
    - name: development-sync
      schedule: "0 0 * * *"  # Always open
      duration: "24h"
      applications:
        - "onekg-*"
      timeZone: "UTC"
      manualSync: true
      automaticSync: true
  
  # Orphaned resource monitoring
  orphanedResources:
    warn: true
    ignore:
      - group: ""
        kind: "ConfigMap"
        name: "kube-root-ca.crt"
      - group: ""
        kind: "Secret"
        name: "default-token-*"
